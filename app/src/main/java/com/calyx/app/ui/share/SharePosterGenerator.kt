package com.calyx.app.ui.share

import android.content.Context
import android.content.Intent
import android.graphics.Bitmap
import android.graphics.Canvas
import android.net.Uri
import android.view.View
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.ComposeView
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.core.content.FileProvider
import com.calyx.app.R
import com.calyx.app.data.models.CallerStats
import com.calyx.app.data.models.RankingCategory
import com.calyx.app.ui.components.ProfileImage
import com.calyx.app.ui.theme.*
import com.calyx.app.utils.DurationFormatter
import com.calyx.app.utils.PhoneNumberUtils
import java.io.File
import java.io.FileOutputStream

/**
 * Share Poster Generator - Creates a 1080x1920 (9:16) image for social sharing.
 * 
 * Design:
 * - Background: Dark nature/forest theme
 * - Header: "My Circle" + App Logo
 * - Center: Top 3 Podium (large)
 * - Lower: Two-column grid for ranks 4-10
 * - Footer: "Generated by Calyx"
 */
object SharePosterGenerator {
    
    private const val POSTER_WIDTH = 1080
    private const val POSTER_HEIGHT = 1920
    
    /**
     * Generate and share a poster with the top 10 contacts.
     */
    fun shareTopContacts(
        context: Context,
        topContacts: List<CallerStats>,
        category: RankingCategory
    ) {
        // Create a ComposeView to render the poster
        val composeView = ComposeView(context).apply {
            setContent {
                PosterContent(
                    topContacts = topContacts.take(10),
                    category = category
                )
            }
        }
        
        // Measure and layout the view
        composeView.measure(
            View.MeasureSpec.makeMeasureSpec(POSTER_WIDTH, View.MeasureSpec.EXACTLY),
            View.MeasureSpec.makeMeasureSpec(POSTER_HEIGHT, View.MeasureSpec.EXACTLY)
        )
        composeView.layout(0, 0, POSTER_WIDTH, POSTER_HEIGHT)
        
        // Create bitmap and draw
        val bitmap = Bitmap.createBitmap(POSTER_WIDTH, POSTER_HEIGHT, Bitmap.Config.ARGB_8888)
        val canvas = Canvas(bitmap)
        composeView.draw(canvas)
        
        // Save to cache and share
        val file = saveBitmapToCache(context, bitmap)
        shareBitmap(context, file)
    }
    
    private fun saveBitmapToCache(context: Context, bitmap: Bitmap): File {
        val cacheDir = File(context.cacheDir, "share")
        cacheDir.mkdirs()
        
        val file = File(cacheDir, "my_circle_${System.currentTimeMillis()}.png")
        FileOutputStream(file).use { out ->
            bitmap.compress(Bitmap.CompressFormat.PNG, 100, out)
        }
        
        return file
    }
    
    private fun shareBitmap(context: Context, file: File) {
        val uri = FileProvider.getUriForFile(
            context,
            "${context.packageName}.fileprovider",
            file
        )
        
        val shareIntent = Intent(Intent.ACTION_SEND).apply {
            type = "image/png"
            putExtra(Intent.EXTRA_STREAM, uri)
            addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
        }
        
        context.startActivity(Intent.createChooser(shareIntent, "Share your circle"))
    }
}

/**
 * The poster content composable (1080x1920).
 */
@Composable
private fun PosterContent(
    topContacts: List<CallerStats>,
    category: RankingCategory
) {
    Box(
        modifier = Modifier
            .width(1080.dp)
            .height(1920.dp)
            .background(
                Brush.verticalGradient(
                    colors = listOf(
                        Color(0xFF0A1F15), // Dark forest
                        Color(0xFF0F3D2E), // Deep green-black
                        Color(0xFF1C6F54).copy(alpha = 0.8f),
                        Color(0xFF0A1F15)
                    )
                )
            )
    ) {
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(48.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            // Header
            Spacer(modifier = Modifier.height(40.dp))
            
            // Logo
            Image(
                painter = painterResource(id = R.drawable.calyx_logo),
                contentDescription = "Calyx",
                modifier = Modifier.size(80.dp)
            )
            
            Spacer(modifier = Modifier.height(24.dp))
            
            Text(
                text = "My Circle",
                fontSize = 48.sp,
                fontWeight = FontWeight.Bold,
                color = Color.White
            )
            
            Text(
                text = when (category) {
                    RankingCategory.MOST_CALLED -> "Most Called"
                    RankingCategory.MOST_TALKED -> "Most Talked"
                },
                fontSize = 20.sp,
                color = LimeAccent
            )
            
            Spacer(modifier = Modifier.height(60.dp))
            
            // Top 3 Podium
            if (topContacts.size >= 3) {
                PosterPodium(
                    first = topContacts[0],
                    second = topContacts[1],
                    third = topContacts[2],
                    category = category
                )
            }
            
            Spacer(modifier = Modifier.height(48.dp))
            
            // Ranks 4-10 in grid
            val remaining = topContacts.drop(3).take(7)
            if (remaining.isNotEmpty()) {
                PosterGrid(
                    contacts = remaining,
                    category = category,
                    startRank = 4
                )
            }
            
            Spacer(modifier = Modifier.weight(1f))
            
            // Footer
            Text(
                text = "Generated by Calyx",
                fontSize = 16.sp,
                color = Color.White.copy(alpha = 0.5f)
            )
            
            Spacer(modifier = Modifier.height(32.dp))
        }
    }
}

@Composable
private fun PosterPodium(
    first: CallerStats,
    second: CallerStats,
    third: CallerStats,
    category: RankingCategory
) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceEvenly,
        verticalAlignment = Alignment.Bottom
    ) {
        // #2
        PosterPodiumItem(
            caller = second,
            rank = 2,
            category = category,
            avatarSize = 100.dp,
            height = 160.dp
        )
        
        // #1
        PosterPodiumItem(
            caller = first,
            rank = 1,
            category = category,
            avatarSize = 140.dp,
            height = 200.dp
        )
        
        // #3
        PosterPodiumItem(
            caller = third,
            rank = 3,
            category = category,
            avatarSize = 90.dp,
            height = 140.dp
        )
    }
}

@Composable
private fun PosterPodiumItem(
    caller: CallerStats,
    rank: Int,
    category: RankingCategory,
    avatarSize: androidx.compose.ui.unit.Dp,
    height: androidx.compose.ui.unit.Dp
) {
    val accentColor = when (rank) {
        1 -> LimeAccent
        2 -> FreshGreen
        else -> DeepGreen
    }
    
    Column(
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        // Avatar with glow for #1
        Box(
            modifier = Modifier
                .size(avatarSize)
                .then(
                    if (rank == 1) {
                        Modifier.border(
                            width = 4.dp,
                            brush = Brush.radialGradient(
                                colors = listOf(LimeAccent, LimeAccent.copy(alpha = 0.3f))
                            ),
                            shape = CircleShape
                        )
                    } else {
                        Modifier.border(3.dp, Color.White.copy(alpha = 0.5f), CircleShape)
                    }
                )
                .clip(CircleShape)
        ) {
            ProfileImage(
                photoUri = caller.profilePhotoUri,
                displayName = caller.displayName,
                size = avatarSize
            )
        }
        
        Spacer(modifier = Modifier.height(12.dp))
        
        // Medal
        Box(
            modifier = Modifier
                .size(36.dp)
                .clip(CircleShape)
                .background(accentColor),
            contentAlignment = Alignment.Center
        ) {
            Text(
                text = "$rank",
                fontSize = 18.sp,
                fontWeight = FontWeight.Bold,
                color = Color.White
            )
        }
        
        Spacer(modifier = Modifier.height(8.dp))
        
        // Name
        Text(
            text = PhoneNumberUtils.getDisplayName(caller.displayName, caller.phoneNumber),
            fontSize = 18.sp,
            fontWeight = FontWeight.SemiBold,
            color = Color.White,
            maxLines = 1,
            overflow = TextOverflow.Ellipsis,
            textAlign = TextAlign.Center,
            modifier = Modifier.width(140.dp)
        )
        
        // Score
        Text(
            text = when (category) {
                RankingCategory.MOST_CALLED -> "${caller.totalCalls} calls"
                RankingCategory.MOST_TALKED -> DurationFormatter.formatShort(caller.totalDuration)
            },
            fontSize = 14.sp,
            color = accentColor
        )
    }
}

@Composable
private fun PosterGrid(
    contacts: List<CallerStats>,
    category: RankingCategory,
    startRank: Int
) {
    Column(
        verticalArrangement = Arrangement.spacedBy(16.dp)
    ) {
        contacts.chunked(2).forEachIndexed { rowIndex, row ->
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.spacedBy(24.dp, Alignment.CenterHorizontally)
            ) {
                row.forEachIndexed { colIndex, caller ->
                    val rank = startRank + (rowIndex * 2) + colIndex
                    PosterGridItem(
                        caller = caller,
                        rank = rank,
                        category = category,
                        modifier = Modifier.weight(1f)
                    )
                }
                // Fill empty space for odd item count
                if (row.size == 1) {
                    Spacer(modifier = Modifier.weight(1f))
                }
            }
        }
    }
}

@Composable
private fun PosterGridItem(
    caller: CallerStats,
    rank: Int,
    category: RankingCategory,
    modifier: Modifier = Modifier
) {
    Row(
        modifier = modifier
            .clip(RoundedCornerShape(16.dp))
            .background(Color.White.copy(alpha = 0.1f))
            .padding(16.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        // Rank
        Text(
            text = "$rank",
            fontSize = 20.sp,
            fontWeight = FontWeight.Bold,
            color = VibrantGreen,
            modifier = Modifier.width(32.dp)
        )
        
        // Avatar
        Box(
            modifier = Modifier
                .size(48.dp)
                .clip(CircleShape)
        ) {
            ProfileImage(
                photoUri = caller.profilePhotoUri,
                displayName = caller.displayName,
                size = 48.dp
            )
        }
        
        Spacer(modifier = Modifier.width(12.dp))
        
        // Info
        Column(
            modifier = Modifier.weight(1f)
        ) {
            Text(
                text = PhoneNumberUtils.getDisplayName(caller.displayName, caller.phoneNumber),
                fontSize = 14.sp,
                fontWeight = FontWeight.SemiBold,
                color = Color.White,
                maxLines = 1,
                overflow = TextOverflow.Ellipsis
            )
            Text(
                text = when (category) {
                    RankingCategory.MOST_CALLED -> "${caller.totalCalls} calls"
                    RankingCategory.MOST_TALKED -> DurationFormatter.formatShort(caller.totalDuration)
                },
                fontSize = 12.sp,
                color = LimeAccent
            )
        }
    }
}
